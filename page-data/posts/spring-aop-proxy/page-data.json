{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/spring-aop-proxy","result":{"data":{"markdownRemark":{"id":"c0bece16-d7d4-5c09-a914-8d0eceecce61","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/973ecc0d861fd884a29097949733b9fe/077b7/proxy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB/klEQVQoz3VSy2sTcRDef8tbUSOC9uKl4EGvHrSCF/FRoz2kpKWoreJBFNTiCwvWgq14qSBsEvPczWaTfSYkhCSb98PQrLufzGhKLxn4+GaG38x8M7vC5oeL2Hy3gBc7lxB+dR5LG2cQejmHh+9P4/ajAIJP53EtdAJb3++CzPN8+P5sCEurC7i3fgErTy7j1to8Fu/P4XrwJB5snMNi8BSu3jmLKzcDuLEaQKmVxD/zMcuET3vr+PrjGb79fI7t/cf4uB/C2y8r2D0Is/96O4ytz2t4s7sMyTzA79EhhsMB+v0+er0e82g0wng8ZgiJXxlYZhlOowNV0aHlbWh5C4qsQ0qrnNM1G1JKRTolQ4yISCaTSCQSEEURkUgE6XQak8kErutCaDYdmJYByzZhGDp0Q4P7Z8JreZ4L3/fIw8Q9hP9/VbrVcTseC5ZlIZVKIRqNIh6P8+R6vY5Op4NWq4V2u81oNpvodrvMjUaDc7VaDY7jMChfrVYhkHxd15HNZqGqKjNBkiReh5hAa8ViMSiKwnGhUEA+nz+CYRgsTCCHGhBTY1mWjx7QANqAYk3TkMlkOE/qCaRqqpxUDodDCDSJGtHkXC7HRVRMIPXTAcSmaTLTG2oyPQv5dIbBYAChUqnww3K5jFKpxI1s20axWORG5FMRfcEpPM+b+R/+Bcc3vXAjtDNgAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/973ecc0d861fd884a29097949733b9fe/8ac56/proxy.webp 240w,\n/static/973ecc0d861fd884a29097949733b9fe/d3be9/proxy.webp 480w,\n/static/973ecc0d861fd884a29097949733b9fe/e46b2/proxy.webp 960w,\n/static/973ecc0d861fd884a29097949733b9fe/308c4/proxy.webp 1166w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/973ecc0d861fd884a29097949733b9fe/8ff5a/proxy.png 240w,\n/static/973ecc0d861fd884a29097949733b9fe/e85cb/proxy.png 480w,\n/static/973ecc0d861fd884a29097949733b9fe/d9199/proxy.png 960w,\n/static/973ecc0d861fd884a29097949733b9fe/077b7/proxy.png 1166w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/973ecc0d861fd884a29097949733b9fe/d9199/proxy.png\"\n            alt=\"proxy\"\n            title=\"proxy\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">AOP = Aspect Oriented Programming</code></p>\n<p>관점 지향 프로그래밍은 한 로직에서 핵심적인 관점으로 보는 로직과 그 외 부가적인 관점으로 보는 로직들을 나누겠다는 프로그래밍 패러다임이고 C++, 루비, 닷넷 프레임워크 등 많은 언어와 프레임워크에서 AOP 를 지원하고 있다.</p>\n<p>사실 예전에 스프링 AOP 공부 할때 프록시 쪽은 제대로 보지 않았었고<br>\n포인트컷.. 어드바이스.. 위빙.. 이런 용어가 있구나.. 프록시가 이거구나.. 정도로 넘어갔던거 같은데, 요즘 우리팀 인턴 분 과제 중 하나가 AOP 패러다임을 차용한 <code class=\"language-text\">resilience4j</code> 의 서킷 브레이커를 활용하는 것이라 이걸 좀 보다 보니 Spring Proxy 를 좀 자세히 알아 봐야겠다는 생각이 들었다.</p>\n<p><code class=\"language-text\">Proxy == 대리인</code></p>\n<p>프록시는 말 그대로 대리인 역할을 한다.</p>\n<h3 id=\"spring-aop-는-proxy-기반으로-jdk-dynamic-proxy-와-cglib-를-활용하여-aop를-제공하고-있다\" style=\"position:relative;\"><a href=\"#spring-aop-%EB%8A%94-proxy-%EA%B8%B0%EB%B0%98%EC%9C%BC%EB%A1%9C-jdk-dynamic-proxy-%EC%99%80-cglib-%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%98%EC%97%AC-aop%EB%A5%BC-%EC%A0%9C%EA%B3%B5%ED%95%98%EA%B3%A0-%EC%9E%88%EB%8B%A4\" aria-label=\"spring aop 는 proxy 기반으로 jdk dynamic proxy 와 cglib 를 활용하여 aop를 제공하고 있다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spring AOP 는 Proxy 기반으로 JDK Dynamic Proxy 와 CGLIB 를 활용하여 AOP를 제공하고 있다.</h3>\n<p>Spring Retry, resilience4j circuit breaker 은 모두 위 두가지 proxy 를 모두 사용할 수 있고, 둘은 작동하는 방식이 완전 다르다.</p>\n<h3 id=\"1-jdk-dynamic-proxy\" style=\"position:relative;\"><a href=\"#1-jdk-dynamic-proxy\" aria-label=\"1 jdk dynamic proxy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. JDK Dynamic Proxy</h3>\n<p>JDK Dynamic Proxy 는 Java 의 reflection 패키지에 존재하는 Proxy 클래스를 통해 생성된 프록시 객체이다.</p>\n<p><code class=\"language-text\">Proxy.newProxyInstance</code> 함수를 사용하여 동적으로 프록시를 만드는데 요 로직 내부에서 프록시 객체를 만들 때, 대리해야 할 객체의 구현 클래스로 객체를 생성하는게 아니라 인터페이스를 구현하여 만드는 형태이기 때문에 대리 대상이 되는 클래스는 무조건 인터페이스가 있어야 한다.</p>\n<p>만약 인터페이스가 아니라 구현 클래스를 인자로 전달한다면 오류가 발생한다.\n아무튼 이를 이용하여 간단한 프록시 동작을 구현하는 코드 예제를 살펴 보자</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> SomeInterface <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">doSth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> SomeImpl <span class=\"token operator\">:</span> SomeInterface <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">doSth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"main activity\"</span></span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token function\">SomeInvocationHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> target<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> InvocationHandler <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>proxy<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">:</span> Method<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> args<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">?</span><span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Before Action\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> method<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args <span class=\"token operator\">?:</span> <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"After Action\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>args<span class=\"token operator\">:</span> Array<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> someInvocationHandler <span class=\"token operator\">=</span> <span class=\"token function\">SomeInvocationHandler</span><span class=\"token punctuation\">(</span><span class=\"token function\">SomeImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">val</span> proxy <span class=\"token operator\">=</span> Proxy<span class=\"token punctuation\">.</span><span class=\"token function\">newProxyInstance</span><span class=\"token punctuation\">(</span>\n        SomeInterface<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">.</span>classLoader<span class=\"token punctuation\">,</span>\n        <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span>SomeInterface<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        someInvocationHandler\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> SomeInterface\n\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span>proxy<span class=\"token punctuation\">.</span><span class=\"token function\">doSth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>프록시가 구현한 <code class=\"language-text\">doSth</code> 함수에는 <code class=\"language-text\">someInvocationHandler</code> 의 invoke 함수에 기입된 내용들이 들어가 있을 것이고 실행하면 아래와 같은 결과가 출력될 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"Before Action\"\n\"main activity\"\n\"After Action\"</code></pre></div>\n<p>JDK Dynamic 프록시에서 중요한 부분은 대리 대상 클래스가 무조건 인터페이스가 있어야 한다는 것이고, 해당 인터페이스를 구현하여 프록시 동작이 일어난다는 것이다.</p>\n<h3 id=\"2-cglib-proxy\" style=\"position:relative;\"><a href=\"#2-cglib-proxy\" aria-label=\"2 cglib proxy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. CGLIB Proxy</h3>\n<p>대리 대상 클래스가 인터페이스가 없다면, CGLIB Proxy 를 사용하는 방법도 있다.<br>\nCGLIB Proxy 는 바이트 코드를 조작하여 동적으로 프록시를 생성하는데, 내부적으로 대리 대상 클래스를 상속받아 프록시를 생성하는 방식이므로 대상 클래스는 final 이면 안된다. (상속 가능해야 한다)</p>\n<p>JDK Dynamic Proxy 에 <code class=\"language-text\">InvocationHandler</code> 가 있었다면 CGLIB 에는 MethodInterceptor 가 있고, JDK Dynamic Proxy 가 <code class=\"language-text\">newProxyInstance </code>로 프록시 객체를 만들었다면 CGLIB 는 <code class=\"language-text\">Enhancer</code> 라는 클래스의 객체가 프록시 객체를 생성한다.</p>\n<p>바로 예제 코드를 보자</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">open</span> <span class=\"token keyword\">class</span> Some <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">open</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">doSth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"main activity\"</span></span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token function\">SomeInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> target<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> MethodInterceptor <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">intercept</span><span class=\"token punctuation\">(</span>obj<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">:</span> Method<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> args<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span><span class=\"token keyword\">out</span> Any<span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> proxy<span class=\"token operator\">:</span> MethodProxy<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Before Action\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> method<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args <span class=\"token operator\">?:</span> <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"After Action\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>args<span class=\"token operator\">:</span> Array<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> enhancer <span class=\"token operator\">=</span> <span class=\"token function\">Enhancer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    enhancer<span class=\"token punctuation\">.</span><span class=\"token function\">setSuperclass</span><span class=\"token punctuation\">(</span>Some<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n    enhancer<span class=\"token punctuation\">.</span><span class=\"token function\">setCallback</span><span class=\"token punctuation\">(</span><span class=\"token function\">SomeInterceptor</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> proxy <span class=\"token operator\">=</span> enhancer<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Some\n    proxy<span class=\"token punctuation\">.</span><span class=\"token function\">doSth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>CGLIB 프록시는 대리 대상 클래스를 상속받아 함수를 오버라이딩 하여 생성하는 방식이기 때문에 대리 대상 클래스에는 기본 생성자가 꼭 필요하고 상속이 가능해야 한다.</p>\n<p>자바는 final 키워드를 붙이기 전 까지는 상속이 가능하지만 코틀린은 기본적으로 final 클래스이기 때문에 아무런 변경자 없이 클래스를 선언하면 상속이 불가능하다. 따라서 코틀린에서 CGLIB 프록시를 사용하려면 대리 대상 클래스와 함수에 위 코드처럼 open 변경자를 잘 설정해야 한다.</p>\n<p>peace!</p>","fields":{"slug":"/posts/2023-03-01---spring-aop-proxy//posts/spring-aop-proxy","tagSlugs":["/tag/spring-aop/","/tag/proxy/","/tag/jdk-dynamic-proxy/","/tag/cglib/"]},"frontmatter":{"date":"2023-03-01T22:40:32.169Z","description":"프록시를 알아야 retry 와 circuit breaker 가 보인다","tags":["spring AOP","proxy","JDK Dynamic Proxy","CGLIB"],"title":"Spring AOP 가 활용하는 두 Proxy","socialImage":{"publicURL":"/static/973ecc0d861fd884a29097949733b9fe/proxy.png"}}}},"pageContext":{"slug":"/posts/2023-03-01---spring-aop-proxy//posts/spring-aop-proxy"}},"staticQueryHashes":["251939775","2764776372","401334301"]}